# 애플리케이션 프로그래밍과 시스템 프로그래밍

* 운영체제가 사용자 프로그램이 I/O 장치의 복잡도를 상당 부분 볼 수 없게 가려주듯이, 브라우저 같은 복잡한 사용자 프로그램은 그 프로그램 위에 만들어진 다른 애플리케이션 프로그램들이 운영체제를 다루는 복잡도를 볼 수 없게 가려준다.
* 브라우저는 고수준 가상 머신이기에 중요한 하부 구조를 감추면서 빠르고 쉽게 프로그램을 작성할 수 있지만, C로 작성할 경우 브라우저가 숨겨준 더 기초적인 동작이 드러난다.

## C 프로그램

### 터미널과 명령줄

* 현재 일반적인 컴퓨터와의 통신은 그래픽 사용자 인터페이스(GUI)를 사용한다.
* 대부분의 컴퓨터 시스템은 그래픽 뒤에 여전히 문자를 통한 명령줄 인터페이스를 제공한다.
* 예전에는 터미널이 컴퓨터 밖에 있는 하드웨어였으나, 이제는 명령 프롬프트라는 소프트웨어로 구현된다.

### 프로그램 빌드

* C는 컴파일 언어이므로 소스 코드를 실행할 수 없고 기계어로 변환하는 과정이 필요하다.
* 다음과 같은 명령어를 터미널에 타이핑해서 기계어 파일을 생성한다. 이를 빌드한다고 한다.
    cc 소스_파일_이름 -o 출력_파일_이름

### 터미널과 장치 드라이버

* 사용자 프로그램은 직접 I/O 장치와 통신하지 않고 운영체제가 중간에서 통신을 중재한다.
* 터미널은 I/O 장치이므로 컴퓨터와 연결하는 선이 물리적으로 존재했었다.
* 다만 오늘날 운영체제는 마치 이런 연결이 진짜 존재하는 것처럼 소프트웨어로 흉내 내어 동작한다.
* 장치 드라이버 : 물리적 장치와 관련한 처리를 담당한다.

### 문맥 전환

* 운영체제는 한 번에 사용자 프로그램을 하나 이상 실행할 수 없고, CPU 내 레지스터 집합이 하나뿐이기 때문에 운영체제가 한 사용자 프로그램을 다른 사용자 프로그램으로 바꿀 때마다 레지스터들을 저장하고 복구해야 한다.
* 이외에도 MMU 레지스터나 I/O 상태 등도 저장하고 복구해야 한다.
* 이처럼 저장하고 복구하는 모든 내용을 프로세스 문맥이라고 한다.
* 문맥 전환 비용은 비싸기 때문에 문맥 전환 횟수를 최소화해야 성능을 향상시킬 수 있다.
* 사용자 프로그램이 입력을 받기 위해서는 시스템 콜로 운영체제의 도움이 필요하다. 
* 다만 시스템 콜 횟수를 최소화하기 위해 사용자 프로그램은 시스템 콜을 사용해 터미널에서 입력을 읽고 싶다는 의사만 표시하고 슬립 상태가 된다.
* 장치 드라이버는 터미널에서 들어오는 문자를 버퍼(buffer)에 저장하고 사용자가 키를 누를 때가 아닌 ENTER를 누를 때에만 사용자 프로그램을 깨운다.
* 버퍼 : 선입선출 데이터 구조
* 사용자가 누른 키가 무엇인지 혼동할 수 있기에 키 입력에 대한 버퍼를 사용하는 것뿐만 아니라 사용자 입력을 즉시 화면에 표시하는 에코(echo)가 필요하다.
* 사용자 키 입력은 프로그램이 디스플레이에 보내는 출력보다 느리기 때문에 입력 버퍼 외에도 출력 버퍼가 필요하다.

### 표준 I/O

* stdio : 표준 입력/출력 라이브러리로 사용자 프로그램이 쓸 수 있는 버퍼 I/O 함수가 들어있다.
* stdio 라이브러리는 버퍼 입력을 지원해 시스템 콜을 한 번만 사용해 장치 드라이버에서 읽은 데이터를 버퍼에 넣을 수 있다.
* 사용자 프로그램을 터미널 장치 드라이버와 연결하기 위해 open 시스템 콜은 파일 이름을 파일을 참조할 수 있는 핸들(handle)이나 파일 디스크립터(file descriptor)로 바꿔준다. 이 핸들은 close 시스템 콜로 닫으면 더 이상 핸들을 사용할 수 없다.

### 런타임 라이브러리와 표준 입출력

* 런타임 라이브러리는 터미널 장치 드라이버와 연관된 파일을 하나는 입력을 위해, 하나는 출력을 위해 연다.
* stdio 라이브러리는 위에서 연 시스템 파일 디스크립터를 파일 포인터와 연관시킨다.
* 파일 포인터 : 버퍼링이나 파일 관리에 필요한 데이터 구조
* stdio는 파일 포인터로 stdin, stdout, stderr를 제공한다.
  * stderr는 표준 오류 출력 파일 포인터로 오류 등의 중요한 정보를 바로 출력하기 위해 출력 버퍼를 사용하지 않는다.

### 버퍼 오버플로

* stdio 내 stdin에서 사용자가 새 줄 문자를 입력할 때까지 받은 입력을 사용자가 제공한 버퍼로 전송하는 gets라는 함수가 있었는데, 이 함수는 입력이 버퍼 끝을 벗어나지 않는지 검사하지 않아 오류를 발생시킬 수 있었다.
* 이로 인해 버퍼 끝을 벗어나는지 검사하는 기능을 추가한 fgets가 나왔으나 여전히 버퍼 오버플로는 조심해야 할 버그 중 하나다.