# 뉴스 피드 시스템 설계

* 뉴스 피드 : 홈 페이지 중앙에 지속적으로 업데이트되는 스토리
  * 사용자 상태 정보 업데이트, 사진, 비디오, 링크, 앱 활동 등을 포함한다.

## 개략적 설계안 제시 및 동의 구하기

### 뉴스 피드 API

* HTTP 프로토콜 기반
* 상태 정보를 업데이트하거나, 뉴스 피드를 가져오거나, 친구를 추가하는 등의 작업을 수행하는 데 사용한다.
* 피드 발행 API : 새 스토리를 포스팅하기 위한 API
  * 인자 : 바디(포스팅 내용), Authorization 헤더(API 호출 인증을 위함)
* 피드 읽기 API : 뉴스 피드를 가져오는 API
  * 인자 : Authorization 헤더(API 호출 인증을 위함)

### 피드 발행

* 사용자 : 모바일 웹이나 브라우저에서 새 포스팅을 올리는 주체
* 로드밸런서 : 트래픽을 웹 서버들로 분산
* 웹 서버 : HTTP 요청을 내부 서비스로 중계
* 포스팅 저장 서비스(post service) : 새 포스팅을 데이터베이스와 캐시에 저장
* 포스팅 전송 서비스(fanout service) : 새 포스팅을 친구의 뉴스 피드에 푸시
  * 뉴스 피드 데이터는 캐시에 보관해 빠르게 읽어갈 수 있도록 한다.
* 알림 서비스(notification service) : 친구들에게 새 포스팅이 올라왔음을 알리거나 푸시 알림을 보낸다.

### 뉴스 피드 생성

* 사용자 : 뉴스 피드를 읽는 주체
* 로드 밸런서 : 트래픽을 웹 서버들로 분산
* 웹 서버 : 트래픽을 뉴스 피드 서비스로 중계
* 뉴스 피드 서비스 : 캐시에서 뉴스 피드를 가져오는 서비스
* 뉴스 피드 캐시 : 뉴스 피드를 렌더링할 때 필요한 피드 ID를 보관

## 상세 설계

### 피드 발행 흐름 상세 설계

* 웹 서버
  * 인증이나 처리율 제한 등의 기능도 수행
* 포스팅 전송(팬아웃) 서비스
  * 팬아웃 : 어떤 사용자의 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정
  * 팬아웃에는 푸시 모델과 풀 모델이 있다.
  * 푸시 모델
    * 쓰기 시점에 팬아웃하는 모델
    * 새로운 포스팅을 기록하는 시점에 뉴스 피드를 갱신한다.
    * 장점
      * 뉴스 피드가 실시간으로 갱신되며 친구 목록에 있는 사용자에게 즉시 전송된다.
      * 새 포스팅이 기록되는 순가넹 뉴스 피드가 이미 갱신되어 뉴스 피드를 읽는 데 드는 시간이 짧아진다.
    * 단점
      * 핫키(hotkey) 문제 : 친구가 많은 사용자의 경우 친구 목록에 있는 사용자 모두의 뉴스 피드를 갱신하는 데 많은 시간이 소요된다.
      * 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신해야 하므로 컴퓨팅 자원을 낭비한다.
  * 풀 모델
    * 읽기 시점에 팬아웃하는 모델
    * 피드를 읽어야 하는 시점에 뉴스 피드를 갱신한다.
    * 장점
      * 서비스를 자주 이용하지 않는 사용자의 경우 이 모델이 유리하다.
      * 데이터를 친구 각각에 푸시하는 작업이 없어 핫키 문제가 없다.
    * 단점
      * 뉴스 피드를 읽는 데 많은 시간이 소요된다.
  * 두 가지 방법을 결합해 일반적으로 푸시 모델을 사용하되 친구가 많은 사용자의 경우 풀 모델을 사용해 시스템 과부하를 방지한다.
  * 안정 해시를 이용해 요청과 데이터를 보다 고르게 분산하면 핫키 문제를 줄일 수 있다.
* 팬아웃 서비스 동작 방식
  * 그래프 데이터베이스에서 친구 ID 목록을 가져온다.
  * 사용자 정보 캐시에서 친구들의 정보를 가져온다. 사용자 설정에 따라 친구 가운데 일부를 걸러낸다.
  * 친구 목록과 새 스토리의 포스팅 ID를 메시지 큐에 넣는다.
  * 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내 뉴스 피드 데이터를 뉴스 피드 캐시에 넣는다.
    * 뉴스 피드 캐시는 \<포스팅 ID, 사용자 ID\>의 순서쌍을 보관하는 매핑 테이블이다.
    * 메모리 크기를 적정 수준으로 유지하기 위해 캐시 크기에 제한을 두고 크기는 조정 가능하도록 한다.
    * 대부분의 사용자는 최신 스토리를 보기에 캐시 미스가 일어날 확률은 낮다.

### 피드 읽기 흐름 상세 설계

* 이미지나 비디오 같은 미디어 컨텐츠는 CDN에 저장해 빨리 읽어갈 수 있도록 한다.
* 뉴스 피드 읽기 과정
  * 사용자가 뉴스 피드 읽기 요청을 보낸다.
  * 로드밸런서가 요청을 웹 서버 가운데 하나로 보낸다.
  * 웹 서버는 피드를 가져오기 위해 뉴스 피드 서비스를 호출한다.
  * 뉴스 피드 서비스는 뉴스 피드 캐시에서 포스팅 ID 목록을 가져온다.
  * 뉴스 피드에 표시할 사용자 이름, 사용자 사진, 포스팅 컨텐츠, 이미지 등을 사용자 캐시와 포스팅 캐시에서 가져와 완전한 뉴스 피드를 만든다.
  * 생성된 뉴스 피드를 JSON 형태로 클라이언트에게 보낸다. 클라이언트는 해당 피드를 렌더링한다.

### 캐시 구조

* 캐시는 뉴스 피드 시스템의 핵심 컴포넌트다.
* 캐시 계층 분할 예시
  * 뉴스 피드 : 뉴스 피드 ID 보관
  * 컨텐츠 : 포스팅 데이터 보관(인기 컨텐츠는 따로 보관)
  * 소셜 그래프 : 사용자 간 관계 정보 보관
  * 행동(action) : 포스팅에 대한 사용자의 행위에 관한 정보 보관(좋아요, 답글 등)
  * 횟수(counter) : 좋아요 횟수, 응답 수, 팔로어 수, 팔로잉 수 등의 정보 보관

## 마무리

* 기타 논의 사항
  * 데이터베이스 규모 확장
    * 수직적 vs 수평적 규모 확장
    * SQL vs NoSQL
    * 주-부 다중화
    * 복제본에 대한 읽기 연산
    * 일관성 모델
    * 데이터베이스 샤딩
  * 웹 계층을 무상태로 운영
  * 가능한 한 많은 데이터를 캐시하는 방법
  * 여러 데이터 센터를 지원할 방법
  * 메시지 큐를 사용해 컴포넌트 사이의 결합도 낮추기
  * 핵심 매트릭에 대한 모니터링
