# URL 단축기 설계

## 문제 이해 및 설계 범위 확정

* 기본적 기능
  * URL 단축 : 주어진 긴 URL을 짧게 줄인다.
  * URL redirection : 축약된 URL로 HTTP 요청이 오면 원래 URL로 안내한다.
  * 높은 가용성과 규모 확장성, 그리고 장애 감내가 요구된다.

## 개략적 설계안 제시 및 동의 구하기

### API 엔드포인트

* URL 단축용 엔드포인트
  * 새 단축 URL을 생성하고자 하는 클라이언트는 단축할 URL을 인자로 실어서 POST 요청을 보내야 한다.
* URL 리디렉션용 엔드포인트
  * 단축 URL에 대해서 HTTP 요청이 오면 원래 URL로 보내주기 위한 용도의 엔드포인트

### URL 리디렉션

* 단축 URL를 받은 서버는 그 URL을 원래 URL로 바꿔서 301 응답의 Location 헤더에 넣어 반환한다.
* 301 응답과 302 응답의 차이
  * 301 Permanently Moved
    * 해당 URL에 대한 HTTP 요청의 처리 책임이 영구적으로 Location 헤더에 반환된 URL로 이전되었다는 응답이다.
    * 브라우저는 이 응답을 캐시하고 이후에 같은 단축 URL에 요청을 보낼 필요가 있으면 브라우저는 캐시된 원래 URL로 요청을 보낸다.
    * 서버 부하를 줄일 수 있다.
  * 302 Found
    * URL로의 요청이 일시적으로 Location 헤더가 지정하는 URL에 의해 처리되어야 한다는 응답이다.
    * 클라이언트의 요청은 언제나 단축 URL 서버에 먼저 보내진 후 원래 URL로 리디렉션되어야 한다.
    * 트래픽 분석이 중요할 떄 유용하다.
* URL 리디렉션을 구현하는 가장 직관적인 방법은 해시 테이블을 사용하는 것이다.

### URL 단축

* 긴 URL을 해시 값으로 대응시킬 해시 함수를 찾아야 한다.
* 해시 함수 요구사항
  * 입력으로 주어지는 긴 URL이 다른 값이면 해시 값도 달라야 한다.
  * 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 한다.

## 상세 설계

### 데이터 모델

* 해시 테이블은 메모리에서 사용하는데, 이는 유한한 데다 비싸기에 적절하지 않다.
* 따라서 id, 단축 URL, 원래 URL의 칼럼을 가진 관계형 데이터베이스에 저장하는 방법을 사용한다.

### 해시 함수

* 단축 URL은 0~9, a~z, A~Z의 문자들로 구성된다. 따라서 총 62개의 문자를 사용할 수 있다.
* 해시 값 길이가 7이면 가능한 경우의 수는 약 3.5조 개다.
* 해시 후 충돌 해소
  * CRC32, MD5, SHA-1같이 잘 알려진 해시 함수를 이용한 뒤, 계산된 해시 값에서 처음 7개 글자만 이용한다.
  * 만약 해시 결과가 충돌하면 충돌이 해소될 때까지 사전에 정한 문자열을 해시값에 덧붙인다.
  * 단축 URL 생성 시 한 번 이상 데이터베이스 질의를 해야 하므로 오버헤드가 크다.
  * 데이터베이스 대신 블룸 필터를 사용하면 성능을 높일 수 있다.
    * 블룸 필터 : 어떤 집합에 특정 원소가 있는지 검사할 수 있도록 하는, 확률론에 기초한 공간 효율이 좋은 기술
  * 단축 URL 길이가 고정된다.
  * 유일성이 보장되는 ID 생성기가 필요하지 않다.
  * 충돌이 가능해서 해소 전략이 필요하다.
  * ID로부터 단축 URL을 계산하는 방식이 아니라서 다음에 쓸 수 있는 URL을 예측할 수 없다.
* base-62 변환
  * 진법 변환을 이용해 구현한다.
  * 단축 URL의 길이가 가변적이다.
  * 유일성 보장 ID 생성기가 필요하다.
  * ID의 유일성이 보장된 후에야 적용 가능한 전략이라 충돌은 불가능하다.
  * ID가 1씩 증가하는 값이면 다음에 쓸 수 있는 단축 URL이 무엇인지 쉽게 알아낼 수 있어 보안 상 문제가 된다.

### URL 단축기 상세 설계

* 처리 흐름
  * 입력으로 긴 URL을 받는다.
  * 데이터베이스에 해당 URL이 있는지 검사한다.
  * 데이터베이스에 있다면 해당 단축 URL을 가져와서 클라이언트에게 반환한다.
  * 데이터베이스에 없다면 해당 URL은 새로 접수된 것이므로 유일한 ID를 생성한다. 이 ID는 데이터베이스의 기본 키가 된다.
  * 62진법 변환을 통해 ID를 단축 URL로 만든다.
  * ID, 단축 URL, 원래 URL로 새 데이터베이스 레코드를 만든 후 단축 URL을 클라이언트에 전달한다.
* ID 생성기의 경우 분산된 환경에서 만들기 어려운데, 분산 ID 생성기를 구현하는 몇 가지 방법은 7장에서 알 수 있다.

### URL 리디렉션 상세 설계

* 동작 흐름
  * 사용자가 단축 URL을 클릭한다.
  * 로드밸런서가 해당 클릭으로 발생한 요청을 웹 서버에 전달한다.
  * 단축 URL이 이미 캐시에 있는 경우 원래 URL을 바로 꺼내서 클라이언트에게 전달한다.
  * 캐시에 단축 URL이 없는 경우 데이터베이스에서 꺼낸다.
  * 데이터베이스에서 꺼낸 URL을 캐시에 넣은 후 사용자에게 반환한다.

## 마무리

* 기타 추가 사항
  * 처리율 제한 장치
    * 엄청난 양의 URL 단축 요청이 밀려올 경우 무력화될 수 있다.
    * 따라서 처리율 제한 장치를 두면 적절한 필터링 규칙을 이용해 요청을 걸러낼 수 있다.
  * 웹 서버의 규모 확장
    * 웹 계층은 무상태 계층이므로 웹 서버를 자유롭게 추가 및 삭제할 수 있다.
  * 데이터베이스의 규모 확장
    * 데이터베이스의 다중화 및 샤딩을 통해 규모 확장성을 달성할 수 있다.
  * 데이터 분석 솔루션
    * URL 단축기에 데이터 분석 솔루션을 통합해 두면 어떤 링크를 얼마나 많은 사용자가 클릭했는지, 언제 주로 클릭했는지 등의 중요한 정보를 알아낼 수 있다.
